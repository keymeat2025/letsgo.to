<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhonePe Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #5f259f;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #response {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h2>PhonePe 1 Rupee Test</h2>
    <button id="payButton">Pay â‚¹1</button>
    <div id="response"></div>

    <script>
        // Replace with your Firebase config
  
        const firebaseConfig = {
            apiKey: "AIzaSyAlYM8lU1844ushiA7A3FtQPEtreQjJ30I",
            authDomain: "letsgoto-a630e.firebaseapp.com",
            projectId: "letsgoto-a630e",
            storageBucket: "letsgoto-a630e.firebasestorage.app",
            messagingSenderId: "194513214154",
            appId: "1:194513214154:web:7825241b22095d7c43f233",
            measurementId: "G-N8CN6LM82S"
          };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        document.getElementById('payButton').addEventListener('click', async () => {
            try {
                const responseDiv = document.getElementById('response');
                responseDiv.textContent = "Initiating payment...";
                
                // Generate a unique transaction ID
                const transactionId = 'TXN_' + Date.now();
                
                // Call the Firebase function
                const initiatePayment = firebase.functions().httpsCallable('initiatePayment');
                const result = await initiatePayment({
                    amount: 1, // 1 rupee
                    transactionId: transactionId,
                    competitionId: 'test-comp-123',
                    registrationId: 'test-reg-123',
                    paymentId: 'test-pay-123',
                    callbackUrl: 'https://us-central1-letsgoto-a630e.cloudfunctions.net/phonepeCallback', // Replace with your callback URL
                    redirectUrl: window.location.href, // Redirect back to this page
                    userDetails: {
                        userId: 'test-user',
                        mobileNumber: '9999999999' // Replace with test number
                    }
                });
                
                // Display the response
                responseDiv.textContent = "Response: " + JSON.stringify(result.data, null, 2);
                
                // If successful, redirect to PhonePe payment page
                if (result.data && result.data.data && result.data.data.instrumentResponse && 
                    result.data.data.instrumentResponse.redirectInfo && 
                    result.data.data.instrumentResponse.redirectInfo.url) {
                    const redirectUrl = result.data.data.instrumentResponse.redirectInfo.url;
                    responseDiv.textContent += "\n\nRedirecting to payment page...";
                    
                    // Save transaction ID for status check
                    localStorage.setItem('lastTransactionId', transactionId);
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                }
            } catch (error) {
                document.getElementById('response').textContent = "Error: " + JSON.stringify(error, null, 2);
            }
        });
        
        // Check if we're returning from a payment
        window.addEventListener('load', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = localStorage.getItem('lastTransactionId');
            
            if (urlParams.has('transactionId') || transactionId) {
                const txnId = urlParams.get('transactionId') || transactionId;
                document.getElementById('response').textContent = "Checking payment status for: " + txnId;
                
                try {
                    const checkStatus = firebase.functions().httpsCallable('checkStatus');
                    const result = await checkStatus({ transactionId: txnId });
                    document.getElementById('response').textContent = "Payment status: " + JSON.stringify(result.data, null, 2);
                } catch (error) {
                    document.getElementById('response').textContent = "Error checking status: " + JSON.stringify(error, null, 2);
                }
            }
        });
    </script>
</body>
</html>
